<?xml version="1.0" encoding="UTF-8"?>
<mets:mets xmlns:mets="http://www.loc.gov/METS/" 
           xmlns:xlink="http://www.w3.org/1999/xlink"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:csip="https://DILCIS.eu/XML/METS/CSIPExtensionMETS"
           xsi:schemaLocation="http://www.loc.gov/METS/ http://www.loc.gov/standards/mets/mets.xsd"
           OBJID="uuid-{{ hoso.rep_uuid | upper }}"
           LABEL="{{ hoso.effective_title | escape_xml }}"
           TYPE="Mixed"
           csip:CONTENTINFORMATIONTYPE="MIXED"
           PROFILE="https://earkcsip.dilcis.eu/profile/E-ARK-CSIP.xml">

    <mets:metsHdr CREATEDATE="{{ created_time | format_date('%Y-%m-%dT%H:%M:%S+07:00') }}"
                  LASTMODDATE="{{ created_time | format_date('%Y-%m-%dT%H:%M:%S+07:00') }}"
                  RECORDSTATUS="NEW"
                  csip:OAISPACKAGETYPE="AIP">
        <mets:agent ROLE="{{ config.software_agent_role }}" TYPE="{{ config.software_agent_type }}" OTHERTYPE="{{ config.software_agent_othertype }}">
            <mets:name>{{ config.software_agent_name }}</mets:name>
            <mets:note csip:NOTETYPE="SOFTWARE VERSION">{{ config.software_agent_version }}</mets:note>
        </mets:agent>
        <mets:agent ROLE="EDITOR" TYPE="ORGANIZATION">
            <mets:name>{{ config.organization_name | escape_xml }}</mets:name>
            <mets:note csip:NOTETYPE="IDENTIFICATIONCODE">{{ config.agency_code }}</mets:note>
        </mets:agent>
        <mets:agent ROLE="ARCHIVIST" TYPE="ORGANIZATION">
            <mets:name>{{ config.archivist_name | escape_xml }}</mets:name>
            <mets:note csip:NOTETYPE="IDENTIFICATIONCODE">{{ config.archivist_code }}</mets:note>
        </mets:agent>
    </mets:metsHdr>

    <mets:dmdSec ID="uuid-{{ hoso.dmd_uuid | upper }}" CREATED="{{ created_time | format_date('%Y-%m-%dT%H:%M:%S+07:00') }}" STATUS="CURRENT">
        <mets:mdRef ID="uuid-{{ hoso.dmd_ref_uuid | upper }}"
                    LOCTYPE="URL" 
                    MDTYPE="OTHER"
                    OTHERMDTYPE="EAD"
                    MDTYPEVERSION="1.0"
                    MIMETYPE="text/xml"
                    SIZE="PLACEHOLDER_EAD_SIZE"
                    CHECKSUM="PLACEHOLDER_EAD_CHECKSUM"
                    CHECKSUMTYPE="SHA-256"
                    CREATED="{{ created_time | format_date('%Y-%m-%dT%H:%M:%S+07:00') }}"
                    xlink:type="simple"
                    xlink:href="../metadata/descriptive/ead.xml"/>
    </mets:dmdSec>

    {% for tai_lieu in hoso.tai_lieu %}
    <mets:dmdSec ID="uuid-{{ tai_lieu.dmd_uuid | upper }}" CREATED="{{ created_time | format_date('%Y-%m-%dT%H:%M:%S+07:00') }}" STATUS="CURRENT">
        <mets:mdRef ID="uuid-{{ tai_lieu.dmd_ref_uuid | upper }}"
                    LOCTYPE="URL" 
                    MDTYPE="OTHER"
                    OTHERMDTYPE="EAD"
                    MDTYPEVERSION="1.0"
                    MIMETYPE="text/xml"
                    SIZE="PLACEHOLDER_EAD_DOC_File{{ loop.index }}_SIZE"
                    CHECKSUM="PLACEHOLDER_EAD_DOC_File{{ loop.index }}_CHECKSUM"
                    CHECKSUMTYPE="SHA-256"
                    CREATED="{{ created_time | format_date('%Y-%m-%dT%H:%M:%S+07:00') }}"
                    xlink:type="simple"
                    xlink:href="metadata/descriptive/EAD_doc_File{{ loop.index }}.xml"/>
    </mets:dmdSec>
    {% endfor %}

    <mets:amdSec ID="uuid-{{ hoso.amd_uuid | upper }}">
        <mets:digiprovMD ID="uuid-{{ hoso.digiprov_uuid | upper }}" STATUS="CURRENT">
            <mets:mdRef ID="uuid-{{ hoso.premis_ref_uuid | upper }}"
                        LOCTYPE="URL" 
                        MDTYPE="PREMIS" 
                        MIMETYPE="text/xml"
                        SIZE="PLACEHOLDER_PREMIS_REP_SIZE"
                        CHECKSUM="PLACEHOLDER_PREMIS_REP_CHECKSUM"
                        CHECKSUMTYPE="SHA-256"
                        CREATED="{{ created_time | format_date('%Y-%m-%dT%H:%M:%S+07:00') }}"
                        xlink:type="simple"
                        xlink:href="metadata/preservation/PREMIS_rep1.xml"/>
        </mets:digiprovMD>
    </mets:amdSec>

    <mets:fileSec ID="uuid-{{ hoso.filesec_uuid | upper }}">
        <mets:fileGrp ID="uuid-{{ hoso.filegroup_uuid | upper }}" USE="Data">
            {% for tai_lieu in hoso.tai_lieu %}
            <mets:file ID="ID-{{ tai_lieu.file_uuid | upper }}" MIMETYPE="application/pdf" 
                       SIZE="{{ tai_lieu.kich_thuoc_file }}"
                       CHECKSUM="{{ tai_lieu.checksum }}" CHECKSUMTYPE="SHA-256"
                       CREATED="{{ created_time | format_date('%Y-%m-%dT%H:%M:%S+07:00') }}">
                <mets:FLocat LOCTYPE="URL" 
                             xlink:href="data/{{ tai_lieu.filename }}" 
                             xlink:type="simple"/>
            </mets:file>
            {% endfor %}
        </mets:fileGrp>
    </mets:fileSec>

    <mets:structMap ID="uuid-{{ hoso.structmap_uuid | upper }}" TYPE="PHYSICAL" LABEL="CSIP">
        <mets:div ID="uuid-{{ hoso.main_div_uuid | upper }}" LABEL="{{ hoso.rep_uuid | upper }}">
            
            <!-- Metadata Section -->
            <mets:div ID="uuid-{{ hoso.metadata_div_uuid | upper }}" LABEL="Metadata">
                <mets:fptr FILEID="uuid-{{ hoso.premis_ref_uuid | upper }}"/>
            </mets:div>
            
            <!-- Data Section -->
            <mets:div ID="uuid-{{ hoso.data_div_uuid | upper }}" LABEL="Data">
                <mets:fptr FILEID="uuid-{{ hoso.filegroup_uuid | upper }}"/>
            </mets:div>
            
            <!-- MetadataLink Section -->
            <mets:div ID="uuid-{{ hoso.metalink_div_uuid | upper }}" LABEL="MetadataLink">
                {% for tai_lieu in hoso.tai_lieu %}
                <mets:div ID="uuid-{{ tai_lieu.metalink_uuid | upper }}" 
                          DMDID="uuid-{{ tai_lieu.dmd_uuid | upper }}" 
                          ADMID="uuid-{{ hoso.digiprov_uuid | upper }}" 
                          LABEL="MetadataLink/File">
                    <mets:fptr FILEID="ID-{{ tai_lieu.file_uuid | upper }}"/>
                </mets:div>
                {% endfor %}
            </mets:div>
            
        </mets:div>
    </mets:structMap>

</mets:mets>
